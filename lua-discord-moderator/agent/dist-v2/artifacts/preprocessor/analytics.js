"use strict";var g=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var b=(e,o)=>{for(var i in o)g(e,i,{get:o[i],enumerable:!0})},C=(e,o,i,a)=>{if(o&&typeof o=="object"||typeof o=="function")for(let s of D(o))!x.call(e,s)&&s!==i&&g(e,s,{get:()=>o[s],enumerable:!(a=I(o,s))||a.enumerable});return e};var k=e=>C(g({},"__esModule",{value:!0}),e);var w={};b(w,{default:()=>S});module.exports=k(w);var u={};b(u,{default:()=>c});var p=require("lua-cli");var f=require("lua-cli");function y(){let e=(0,f.env)("DISCORD_REQUEST_CONTEXT");if(console.log("DISCORD_REQUEST_CONTEXT:",e),!e)return null;try{return JSON.parse(e)}catch{return console.error("Failed to parse DISCORD_REQUEST_CONTEXT:",e),null}}var _=new p.PreProcessor({name:"analytics",description:"Captures interaction data and syncs Discord ID to user profile",priority:10,execute:async(e,o,i)=>{let a=o.find(r=>r.type==="text"),s=a?.type==="text"?a.text:"",t=y();if(!t)return{action:"proceed"};if(t.authorId&&!e.discordId)try{let r=await e.update({discordId:t.authorId,discordTag:t.authorTag});console.log("[Analytics] Discord ID saved to user:",r)}catch(r){console.log("[Analytics] Failed to save Discord ID to user:",r)}let m={tools:/\b(tool|tools|LuaTool)\b/i,skills:/\b(skill|skills|LuaSkill)\b/i,webhooks:/\b(webhook|webhooks)\b/i,jobs:/\b(job|jobs|cron|schedule|reminder)\b/i,preprocessors:/\b(preprocessor|preprocess)\b/i,postprocessors:/\b(postprocessor|postprocess)\b/i,data_api:/\b(data api|Data\.|vector|search|collection)\b/i,user_api:/\b(user api|User\.|profile)\b/i,mcp:/\b(mcp|MCP)\b/i,deploy:/\b(deploy|push|compile)\b/i,error:/\b(error|bug|issue|broken|not working)\b/i},d=[];for(let[r,T]of Object.entries(m))T.test(s)&&d.push(r);let l=new Date,h={timestamp:l.toISOString(),date:l.toISOString().split("T")[0],hour:l.getHours(),dayOfWeek:l.getDay(),discordChannelId:t.channelId,discordChannelName:t.channelName,discordChannelType:t.channelType,discordGuildId:t.guildId,discordAuthorId:t.authorId,discordAuthorTag:t.authorTag,discordIsThread:t.isThread,discordTrigger:t.trigger,messageLength:s.length,hasQuestion:s.includes("?"),hasCodeBlock:s.includes("```"),detectedTopics:d,topicCount:d.length};try{let r=`${h.date} ${t.channelName} ${t.authorTag} ${d.join(" ")}`;await p.Data.create("analytics",h,r)}catch(r){console.log("[Analytics] Failed to save:",r)}return{action:"proceed"}}}),c=_;var n=null;for(let e of Object.keys(u)){let o=u[e];if(o&&o.name==="analytics"&&typeof o.execute=="function"){n=o;break}}!n&&c&&c.name==="analytics"&&(n=c);if(!n)throw new Error('PreProcessor "analytics" not found in source');var O={version:"2.0.0",kind:"preprocessor",name:"analytics",description:"Captures interaction data and syncs Discord ID to user profile",pattern:"constructor"},S={__lua_primitive__:O,primitive:{kind:"preprocessor",name:n.name,description:n.description,execute:n.execute}};
