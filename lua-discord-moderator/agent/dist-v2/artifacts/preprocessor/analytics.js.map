{
  "version": 3,
  "sources": ["preprocessor-analytics.ts", "../../src/preprocessors/analytics.ts", "../../src/utils/discord-context.ts"],
  "sourcesContent": ["\n// =============================================================================\n// AUTO-GENERATED ENTRY POINT (PreProcessor)\n// PreProcessor: analytics\n// Source: /Users/raresastilean/Documents/Lua/Repos/lua-dev-examples/lua-discord-moderator/agent/src/preprocessors/analytics.ts\n// =============================================================================\n\n// Import everything from the source file\nimport * as sourceModule from '/Users/raresastilean/Documents/Lua/Repos/lua-dev-examples/lua-discord-moderator/agent/src/preprocessors/analytics.ts';\n\n// Find the PreProcessor by name\nlet preprocessor = null;\nfor (const key of Object.keys(sourceModule)) {\n  const value = sourceModule[key];\n  if (value && value.name === \"analytics\" && typeof value.execute === 'function') {\n    preprocessor = value;\n    break;\n  }\n}\n\n// If not found as named export, check default export\nif (!preprocessor && sourceModule.default) {\n  if (sourceModule.default.name === \"analytics\") {\n    preprocessor = sourceModule.default;\n  }\n}\n\nif (!preprocessor) {\n  throw new Error('PreProcessor \"analytics\" not found in source');\n}\n\n// Runtime metadata\nconst __lua_primitive__ = {\n  version: '2.0.0',\n  kind: 'preprocessor',\n  name: \"analytics\",\n  description: \"Captures interaction data and syncs Discord ID to user profile\",\n  pattern: 'constructor',\n};\n\nexport default {\n  __lua_primitive__,\n  primitive: {\n    kind: 'preprocessor',\n    name: preprocessor.name,\n    description: preprocessor.description,\n    execute: preprocessor.execute,\n  },\n};\n", "import { PreProcessor, Data } from \"lua-cli\";\nimport { getDiscordContext } from \"../utils/discord-context\";\n\n/**\n * Analytics PreProcessor\n * \n * Captures every interaction with full Discord context.\n * Discord info is passed via envOverride from bot.ts as DISCORD_CONTEXT JSON.\n * \n * Also saves the Discord user ID to the user profile for future use\n * by tools like SetReminderTool.\n * \n * Tracks:\n * - Discord context (channel, user, guild)\n * - Timestamp and usage patterns\n * - Detected lua-cli topics\n * \n * Use cases:\n * - Most active channels\n * - Most active users  \n * - Peak usage hours\n * - Popular topics\n */\nconst analyticsPreProcessor = new PreProcessor({\n  name: \"analytics\",\n  description: \"Captures interaction data and syncs Discord ID to user profile\",\n  priority: 10, // Run after rate limiter\n  execute: async (userInstance, messages, channel) => {\n    const latestMessage = messages.find((msg) => msg.type === \"text\");\n    const messageText = latestMessage?.type === \"text\" ? latestMessage.text : \"\";\n\n    // Get Discord context from envOverride\n    const ctx = getDiscordContext();\n    if (!ctx) {\n      return { action: \"proceed\" };\n    }\n\n    // Save Discord ID to user profile if not already set\n    // This allows tools like SetReminderTool to access it later via User API\n    if (ctx.authorId && !userInstance.discordId) {\n      try {\n        const result = await userInstance.update({ discordId: ctx.authorId, discordTag: ctx.authorTag });\n        console.log(\"[Analytics] Discord ID saved to user:\", result);\n      } catch (error) {\n        console.log(\"[Analytics] Failed to save Discord ID to user:\", error);\n      }\n    }\n\n    // Detect lua-cli topics mentioned\n    const topicPatterns: Record<string, RegExp> = {\n      tools: /\\b(tool|tools|LuaTool)\\b/i,\n      skills: /\\b(skill|skills|LuaSkill)\\b/i,\n      webhooks: /\\b(webhook|webhooks)\\b/i,\n      jobs: /\\b(job|jobs|cron|schedule|reminder)\\b/i,\n      preprocessors: /\\b(preprocessor|preprocess)\\b/i,\n      postprocessors: /\\b(postprocessor|postprocess)\\b/i,\n      data_api: /\\b(data api|Data\\.|vector|search|collection)\\b/i,\n      user_api: /\\b(user api|User\\.|profile)\\b/i,\n      mcp: /\\b(mcp|MCP)\\b/i,\n      deploy: /\\b(deploy|push|compile)\\b/i,\n      error: /\\b(error|bug|issue|broken|not working)\\b/i,\n    };\n\n    const detectedTopics: string[] = [];\n    for (const [topic, pattern] of Object.entries(topicPatterns)) {\n      if (pattern.test(messageText)) {\n        detectedTopics.push(topic);\n      }\n    }\n\n    // Build analytics record\n    const now = new Date();\n    const analyticsRecord = {\n      // Timestamps\n      timestamp: now.toISOString(),\n      date: now.toISOString().split(\"T\")[0],\n      hour: now.getHours(),\n      dayOfWeek: now.getDay(),\n\n      // Discord context\n      discordChannelId: ctx.channelId,\n      discordChannelName: ctx.channelName,\n      discordChannelType: ctx.channelType,\n      discordGuildId: ctx.guildId,\n      discordAuthorId: ctx.authorId,\n      discordAuthorTag: ctx.authorTag,\n      discordIsThread: ctx.isThread,\n      discordTrigger: ctx.trigger,\n\n      // Message characteristics\n      messageLength: messageText.length,\n      hasQuestion: messageText.includes(\"?\"),\n      hasCodeBlock: messageText.includes(\"```\"),\n\n      // Topics\n      detectedTopics,\n      topicCount: detectedTopics.length,\n    };\n\n    // Save to analytics collection\n    try {\n      const searchText = `${analyticsRecord.date} ${ctx.channelName} ${ctx.authorTag} ${detectedTopics.join(\" \")}`;\n      await Data.create(\"analytics\", analyticsRecord, searchText);\n    } catch (error) {\n      console.log(\"[Analytics] Failed to save:\", error);\n    }\n\n    // Always proceed - analytics never blocks\n    return { action: \"proceed\" };\n  },\n});\n\nexport default analyticsPreProcessor;\n", "import { env } from \"lua-cli\";\n\n/**\n * Discord context passed from bot.ts via envOverride.\n */\nexport interface DiscordContext {\n  channelId: string;\n  channelName: string;\n  channelType: string;\n  guildId: string;\n  authorId: string;\n  authorTag: string;\n  messageId: string;\n  isThread: boolean;\n  parentId?: string;\n  trigger: string;\n}\n\n/**\n * Get the Discord context from the DISCORD_REQUEST_CONTEXT env variable.\n * Returns null if not available (e.g., not called from Discord).\n */\nexport function getDiscordContext(): DiscordContext | null {\n  const contextJson = env(\"DISCORD_REQUEST_CONTEXT\");\n  console.log(\"DISCORD_REQUEST_CONTEXT:\", contextJson);\n  if (!contextJson) return null;\n  \n  try {\n    return JSON.parse(contextJson) as DiscordContext;\n  } catch {\n    console.error(\"Failed to parse DISCORD_REQUEST_CONTEXT:\", contextJson);\n    return null;\n  }\n}\n\n"],
  "mappings": "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",
  "names": ["preprocessor_analytics_exports", "__export", "preprocessor_analytics_default", "__toCommonJS", "analytics_exports", "__export", "analytics_default", "import_lua_cli", "import_lua_cli", "getDiscordContext", "contextJson", "analyticsPreProcessor", "userInstance", "messages", "channel", "latestMessage", "msg", "messageText", "ctx", "getDiscordContext", "result", "error", "topicPatterns", "detectedTopics", "topic", "pattern", "now", "analyticsRecord", "searchText", "analytics_default", "preprocessor", "key", "analytics_exports", "value", "analytics_default", "__lua_primitive__", "preprocessor_analytics_default"]
}
