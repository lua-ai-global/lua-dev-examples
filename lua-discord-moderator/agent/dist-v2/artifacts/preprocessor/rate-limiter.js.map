{
  "version": 3,
  "sources": ["preprocessor-rate-limiter.ts", "../../src/preprocessors/rate-limiter.ts", "../../src/utils/discord-context.ts"],
  "sourcesContent": ["\n// =============================================================================\n// AUTO-GENERATED ENTRY POINT (PreProcessor)\n// PreProcessor: rate-limiter\n// Source: /Users/raresastilean/Documents/Lua/Repos/lua-dev-examples/lua-discord-moderator/agent/src/preprocessors/rate-limiter.ts\n// =============================================================================\n\n// Import everything from the source file\nimport * as sourceModule from '/Users/raresastilean/Documents/Lua/Repos/lua-dev-examples/lua-discord-moderator/agent/src/preprocessors/rate-limiter.ts';\n\n// Find the PreProcessor by name\nlet preprocessor = null;\nfor (const key of Object.keys(sourceModule)) {\n  const value = sourceModule[key];\n  if (value && value.name === \"rate-limiter\" && typeof value.execute === 'function') {\n    preprocessor = value;\n    break;\n  }\n}\n\n// If not found as named export, check default export\nif (!preprocessor && sourceModule.default) {\n  if (sourceModule.default.name === \"rate-limiter\") {\n    preprocessor = sourceModule.default;\n  }\n}\n\nif (!preprocessor) {\n  throw new Error('PreProcessor \"rate-limiter\" not found in source');\n}\n\n// Runtime metadata\nconst __lua_primitive__ = {\n  version: '2.0.0',\n  kind: 'preprocessor',\n  name: \"rate-limiter\",\n  description: \"Per-user rate limiting for DMs only\",\n  pattern: 'constructor',\n};\n\nexport default {\n  __lua_primitive__,\n  primitive: {\n    kind: 'preprocessor',\n    name: preprocessor.name,\n    description: preprocessor.description,\n    execute: preprocessor.execute,\n  },\n};\n", "import { PreProcessor } from \"lua-cli\";\nimport { getDiscordContext } from \"../utils/discord-context\";\n\n/**\n * Rate Limiter PreProcessor\n * \n * Limits DM messages per user using the User API.\n * Now that we have session-based auth, each Discord user has their own\n * user profile, so we store rate limit timestamps directly on the user.\n * \n * Config:\n * - 5 messages per minute per user (DMs only)\n * - Blocked users get a friendly message\n */\nconst rateLimiterPreProcessor = new PreProcessor({\n  name: \"rate-limiter\",\n  description: \"Per-user rate limiting for DMs only\",\n  priority: 1, // Run first\n  execute: async (userInstance, messages, channel) => {\n    const RATE_LIMIT_WINDOW = 60000; // 1 minute\n    const RATE_LIMIT_MAX = 5; // 5 messages per minute\n\n    // Only rate limit DMs\n    const ctx = getDiscordContext();\n    if (!ctx || ctx.trigger !== \"dm\") {\n      return { action: \"proceed\" };\n    }\n\n    const now = Date.now();\n\n    try {      \n      // Get stored timestamps, filter to current window\n      const storedTimestamps: number[] = userInstance.rateLimitTimestamps || [];\n      const timestamps = storedTimestamps.filter(\n        (ts: number) => now - ts < RATE_LIMIT_WINDOW\n      );\n      \n      // Check if rate limited\n      if (timestamps.length >= RATE_LIMIT_MAX) {\n        const waitTime = Math.ceil((RATE_LIMIT_WINDOW - (now - timestamps[0])) / 1000);\n        return {\n          action: \"block\",\n          response: `\uD83D\uDC22 Slow down! You've sent ${RATE_LIMIT_MAX} messages in the last minute. Try again in ${waitTime} seconds.`,\n        };\n      }\n\n      // Add current timestamp and save\n      timestamps.push(now);\n      await userInstance.update({ rateLimitTimestamps: timestamps });\n    } catch (error) {\n      // Don't block on errors - let message through\n      console.log(\"[RateLimiter] Error:\", error);\n    }\n\n    return { action: \"proceed\" };\n  },\n});\n\nexport default rateLimiterPreProcessor;\n", "import { env } from \"lua-cli\";\n\n/**\n * Discord context passed from bot.ts via envOverride.\n */\nexport interface DiscordContext {\n  channelId: string;\n  channelName: string;\n  channelType: string;\n  guildId: string;\n  authorId: string;\n  authorTag: string;\n  messageId: string;\n  isThread: boolean;\n  parentId?: string;\n  trigger: string;\n}\n\n/**\n * Get the Discord context from the DISCORD_REQUEST_CONTEXT env variable.\n * Returns null if not available (e.g., not called from Discord).\n */\nexport function getDiscordContext(): DiscordContext | null {\n  const contextJson = env(\"DISCORD_REQUEST_CONTEXT\");\n  console.log(\"DISCORD_REQUEST_CONTEXT:\", contextJson);\n  if (!contextJson) return null;\n  \n  try {\n    return JSON.parse(contextJson) as DiscordContext;\n  } catch {\n    console.error(\"Failed to parse DISCORD_REQUEST_CONTEXT:\", contextJson);\n    return null;\n  }\n}\n\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GCAA,IAAAI,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,IAAAC,EAA6B,mBCA7B,IAAAC,EAAoB,mBAsBb,SAASC,GAA2C,CACzD,IAAMC,KAAc,OAAI,yBAAyB,EAEjD,GADA,QAAQ,IAAI,2BAA4BA,CAAW,EAC/C,CAACA,EAAa,OAAO,KAEzB,GAAI,CACF,OAAO,KAAK,MAAMA,CAAW,CAC/B,MAAQ,CACN,eAAQ,MAAM,2CAA4CA,CAAW,EAC9D,IACT,CACF,CDnBA,IAAMC,EAA0B,IAAI,eAAa,CAC/C,KAAM,eACN,YAAa,sCACb,SAAU,EACV,QAAS,MAAOC,EAAcC,EAAUC,IAAY,CAKlD,IAAMC,EAAMC,EAAkB,EAC9B,GAAI,CAACD,GAAOA,EAAI,UAAY,KAC1B,MAAO,CAAE,OAAQ,SAAU,EAG7B,IAAME,EAAM,KAAK,IAAI,EAErB,GAAI,CAGF,IAAMC,GAD6BN,EAAa,qBAAuB,CAAC,GACpC,OACjCO,GAAeF,EAAME,EAAK,GAC7B,EAGA,GAAID,EAAW,QAAU,EAEvB,MAAO,CACL,OAAQ,QACR,SAAU,gFAHK,KAAK,MAAM,KAAqBD,EAAMC,EAAW,CAAC,IAAM,GAAI,CAGgC,WAC7G,EAIFA,EAAW,KAAKD,CAAG,EACnB,MAAML,EAAa,OAAO,CAAE,oBAAqBM,CAAW,CAAC,CAC/D,OAASE,EAAO,CAEd,QAAQ,IAAI,uBAAwBA,CAAK,CAC3C,CAEA,MAAO,CAAE,OAAQ,SAAU,CAC7B,CACF,CAAC,EAEMC,EAAQV,ED/Cf,IAAIW,EAAe,KACnB,QAAWC,KAAO,OAAO,KAAKC,CAAY,EAAG,CAC3C,IAAMC,EAAQD,EAAaD,CAAG,EAC9B,GAAIE,GAASA,EAAM,OAAS,gBAAkB,OAAOA,EAAM,SAAY,WAAY,CACjFH,EAAeG,EACf,KACF,CACF,CAGI,CAACH,GAA6BI,GACfA,EAAQ,OAAS,iBAChCJ,EAA4BI,GAIhC,GAAI,CAACJ,EACH,MAAM,IAAI,MAAM,iDAAiD,EAInE,IAAMK,EAAoB,CACxB,QAAS,QACT,KAAM,eACN,KAAM,eACN,YAAa,sCACb,QAAS,aACX,EAEOC,EAAQ,CACb,kBAAAD,EACA,UAAW,CACT,KAAM,eACN,KAAML,EAAa,KACnB,YAAaA,EAAa,YAC1B,QAASA,EAAa,OACxB,CACF",
  "names": ["preprocessor_rate_limiter_exports", "__export", "preprocessor_rate_limiter_default", "__toCommonJS", "rate_limiter_exports", "__export", "rate_limiter_default", "import_lua_cli", "import_lua_cli", "getDiscordContext", "contextJson", "rateLimiterPreProcessor", "userInstance", "messages", "channel", "ctx", "getDiscordContext", "now", "timestamps", "ts", "error", "rate_limiter_default", "preprocessor", "key", "rate_limiter_exports", "value", "rate_limiter_default", "__lua_primitive__", "preprocessor_rate_limiter_default"]
}
